<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Super</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }
        
        /* 1. LOGIN EKRANI */
        #login-screen { text-align: center; margin-top: 100px; }
        .login-input { padding: 12px; margin: 10px auto; width: 280px; display: block; border: 1px solid #ddd; border-radius: 5px; }
        
        /* 2. DASHBOARD (RO'YXAT) EKRANI */
        #dashboard-screen { display: none; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px; }
        .post-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;}
        .post-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .post-title { font-weight: bold; font-size: 18px; color: #333; }
        .post-date { color: #888; font-size: 14px; }

        /* 3. EDITOR EKRANI */
        #editor-screen { display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input.article-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        #editor-container { height: 400px; margin-bottom: 20px; font-family: 'Georgia', serif; font-size: 18px; }

        /* TUGMALAR */
        .btn { border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; } /* Yashil (Publish) */
        .btn-warning { background: #ffc107; color: #333; }   /* Sariq (Update) */
        .btn-danger { background: #dc3545; color: white; }   /* Qizil (Delete) */
        .btn-secondary { background: #6c757d; color: white; } /* Kulrang (Back) */
        .btn:hover { opacity: 0.9; }

        .action-bar { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>Admin Tizimiga Kirish</h2>
        <input type="email" id="email" class="login-input" placeholder="Email">
        <input type="password" id="password" class="login-input" placeholder="Parol">
        <button class="btn btn-primary" id="loginBtn">KIRISH</button>
        <p id="error-msg" style="color: red; display: none; margin-top: 10px;"></p>
    </div>

    <div id="dashboard-screen">
        <div class="dash-header">
            <h2>Mening Maqolalarim</h2>
            <div>
                <button class="btn btn-primary" id="newPostBtn">+ Yangi Maqola</button>
                <button class="btn btn-danger" id="logoutBtn" style="margin-left: 10px;">Chiqish</button>
            </div>
        </div>
        <div id="posts-list">Yuklanmoqda...</div>
    </div>

    <div id="editor-screen">
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" id="backBtn">‚Üê Bekor qilish</button>
        </div>

        <h2 id="editor-heading">Yangi Maqola</h2>
        <input type="text" id="title" class="article-input" placeholder="Sarlavha (Title)">
        <input type="text" id="author" class="article-input" placeholder="Muallif (Author)">
        
        <div id="editor-container"></div>

        <div class="action-bar">
            <button class="btn btn-danger" id="deleteBtn" style="display:none;">O'chirish</button>
            <button class="btn btn-success" id="publishBtn">CHOP ETISH (Publish)</button>
            <button class="btn btn-warning" id="updateBtn" style="display:none;">SAQLASH (Update)</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

       // !!! O'ZINGIZNING CONFIGINGIZ !!!
        // !!! BU YERGA O'ZINGIZNING KONFIGURATSIYANGIZNI QO'YING !!!
        const firebaseConfig = {
            apiKey: "AIzaSyBJpPJgM7sxXB25IGDUK5jgQhdhB7fyYK4",
            authDomain: "alharitmuz.firebaseapp.com",
            projectId: "alharitmuz",
            storageBucket: "alharitmuz.firebasestorage.app",
            messagingSenderId: "289669454602",
            appId: "1:289669454602:web:f4470c28176b7586c8b8f3",
            measurementId: "G-C0Q1C9NLE7"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Ekran elementlari
        const screens = {
            login: document.getElementById('login-screen'),
            dashboard: document.getElementById('dashboard-screen'),
            editor: document.getElementById('editor-screen')
        };

        let currentDocId = null; // Qaysi maqolani tahrirlayotganimizni bilish uchun

        // --- AUTH LOGIKASI ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                showScreen('dashboard');
                loadPosts(); // Kirganda ro'yxatni yuklash
            } else {
                showScreen('login');
            }
        });

        document.getElementById('loginBtn').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, pass).catch(e => {
                document.getElementById('error-msg').style.display = 'block';
                document.getElementById('error-msg').innerText = e.message;
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

        // --- EKRAN ALMASHTIRISH ---
        function showScreen(name) {
            Object.values(screens).forEach(el => el.style.display = 'none');
            screens[name].style.display = 'block';
        }

        // --- DASHBOARD LOGIKASI (RO'YXAT) ---
        async function loadPosts() {
            const listDiv = document.getElementById('posts-list');
            listDiv.innerHTML = 'Yuklanmoqda...';

            try {
                // Maqolalarni sanasi bo'yicha olish
                const q = query(collection(db, "stories"), orderBy("date", "desc")); // yoki qulayroq saralash
                // Agar orderBy da xatolik bersa, shunchaki: const q = collection(db, "stories");
                
                const querySnapshot = await getDocs(collection(db, "stories"));
                
                listDiv.innerHTML = ''; // Tozalash
                
                if(querySnapshot.empty) {
                    listDiv.innerHTML = '<p>Maqolalar yo\'q.</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'post-item';
                    div.innerHTML = `
                        <span class="post-title">${data.title}</span>
                        <span class="post-date">${data.date}</span>
                    `;
                    // Bosganda Tahrirlashga o'tish
                    div.onclick = () => openEditor(doc.id);
                    listDiv.appendChild(div);
                });

            } catch (e) {
                console.error(e);
                listDiv.innerHTML = 'Xatolik: ' + e.message;
            }
        }

        // --- EDITOR LOGIKASI ---
        document.getElementById('newPostBtn').addEventListener('click', () => openEditor(null)); // Yangi
        document.getElementById('backBtn').addEventListener('click', () => {
            showScreen('dashboard');
            loadPosts(); // Qaytganda ro'yxatni yangilash
        });

        async function openEditor(id) {
            showScreen('editor');
            initQuill();
            
            const titleIn = document.getElementById('title');
            const authorIn = document.getElementById('author');
            const pubBtn = document.getElementById('publishBtn');
            const updBtn = document.getElementById('updateBtn');
            const delBtn = document.getElementById('deleteBtn');
            const heading = document.getElementById('editor-heading');

            currentDocId = id; // ID ni saqlab qo'yamiz

            if (id) {
                // EDIT MODE (TAHRIRLASH)
                heading.innerText = "Maqolani Tahrirlash";
                pubBtn.style.display = 'none';
                updBtn.style.display = 'inline-block';
                delBtn.style.display = 'inline-block';

                // Ma'lumotni yuklash
                const docSnap = await getDoc(doc(db, "stories", id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    titleIn.value = data.title;
                    authorIn.value = data.author;
                    window.quill.root.innerHTML = data.content;
                }
            } else {
                // NEW MODE (YANGI)
                heading.innerText = "Yangi Maqola Yozish";
                pubBtn.style.display = 'inline-block';
                updBtn.style.display = 'none';
                delBtn.style.display = 'none';

                // Tozalash
                titleIn.value = '';
                authorIn.value = '';
                window.quill.root.innerHTML = '';
            }
        }

        function initQuill() {
            if (window.quill) return;
            const script = document.createElement('script');
            script.src = "https://cdn.quilljs.com/1.3.6/quill.js";
            script.onload = () => {
                window.quill = new Quill('#editor-container', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            ['link', 'image', 'video'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    }
                });
            };
            document.head.appendChild(script);
        }

        // 1. PUBLISH (Yangi saqlash)
        document.getElementById('publishBtn').addEventListener('click', async () => {
            const btn = document.getElementById('publishBtn');
            btn.innerText = "Saqlanmoqda...";
            try {
                await addDoc(collection(db, "stories"), {
                    title: document.getElementById('title').value,
                    author: document.getElementById('author').value,
                    content: window.quill.root.innerHTML,
                    date: new Date().toLocaleDateString()
                });
                alert("Chop etildi!");
                btn.innerText = "CHOP ETISH";
                showScreen('dashboard');
                loadPosts();
            } catch (e) {
                alert("Xato: " + e.message);
                btn.innerText = "CHOP ETISH";
            }
        });

        // 2. UPDATE (Yangilash)
        document.getElementById('updateBtn').addEventListener('click', async () => {
            if (!currentDocId) return;
            const btn = document.getElementById('updateBtn');
            btn.innerText = "Yangilanmoqda...";
            try {
                const docRef = doc(db, "stories", currentDocId);
                await updateDoc(docRef, {
                    title: document.getElementById('title').value,
                    author: document.getElementById('author').value,
                    content: window.quill.root.innerHTML
                    // Sanani o'zgartirmaymiz, xohlasangiz updatedDate qo'shish mumkin
                });
                alert("Yangilandi!");
                btn.innerText = "SAQLASH";
                showScreen('dashboard');
                loadPosts();
            } catch (e) {
                alert("Xato: " + e.message);
                btn.innerText = "SAQLASH";
            }
        });

        // 3. DELETE (O'chirish)
        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (!currentDocId) return;
            if (confirm("Rostdan ham bu maqolani o'chirmoqchimisiz?")) {
                try {
                    await deleteDoc(doc(db, "stories", currentDocId));
                    alert("O'chirildi!");
                    showScreen('dashboard');
                    loadPosts();
                } catch (e) {
                    alert("Xato: " + e.message);
                }
            }
        });

    </script>
</body>
</html>
